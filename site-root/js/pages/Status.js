Ext.define("Site.page.Status",{singleton:true,constructor:function(){var b=this,a=b.endpoints=new Ext.util.Collection({keyFn:function(c){return c.ID}});a.add(window.SiteEnvironment&&window.SiteEnvironment.gkEndpoints);Ext.onReady(b.onDocReady,b)},onDocReady:function(){var a=this;if(!window.google){window.alert("Failed to load Google charts library, charts will be unavailable");return}google.load("visualization","1",{packages:["annotationchart","gauge"],callback:Ext.bind(a.onGoogleChartsReady,a)})},onGoogleChartsReady:function(){var a=this;a.initCacheStatus(function(){a.initTopRequestEndpoints(function(){a.initTopBytesEndpoints(function(){a.initTopTimeEndpoints()})})})},bytes2megabytes:function(a){return Math.round(a/1024/1024)},initCacheStatus:function(c){var b=this,a=new google.visualization.Gauge(Ext.fly("cache-status").appendChild({cls:"chart-gauge",style:{height:"300px"},html:"Loading chart&hellip;"},true));Ext.Ajax.request({method:"GET",url:"/status/cache",withCredentials:true,headers:{Accept:"application/json"},success:function(e){var h=Ext.decode(e.responseText),j=b.bytes2megabytes,i=h.total,f=h.free,d=h.responses,g=i-f,k=j(i);a.draw(google.visualization.arrayToDataTable([["Label","Value"],["Responses",j(d)],["System",j(g-d)],["Total",j(g)]]),{max:k,redFrom:k*0.8,redTo:k,yellowFrom:k*0.6,yellowTo:k*0.8,greenFrom:0,greenTo:k*0.2,minorTicks:5});Ext.callback(c,b)}})},initTopRequestEndpoints:function(c){var b=this,a=new google.visualization.AnnotationChart(Ext.fly("top-endpoints-requests").appendChild({cls:"chart-timeline",style:{height:"400px"},html:"Loading chart&hellip;"},true));Ext.Ajax.request({method:"GET",url:"/metrics/endpoints-historic",withCredentials:true,params:{metrics:"requests","time-min":"1 month ago"},headers:{Accept:"application/json"},success:function(m){var h=b.endpoints,d=Ext.decode(m.responseText),g=new google.visualization.DataTable(),k=d.data,u=k.length,n=0,q={},l={},s=[],o,j,p,t,v,f,e;for(;n<u;n++){o=k[n];j=o.Timestamp;p=o.EndpointID;t=o.Value;if(!(j in q)){q[j]={}}q[j][p]=t;if(!(p in l)){l[p]=0}l[p]+=t}s=Ext.Object.getKeys(l);s=Ext.Array.sort(s,function(r,i){r=l[r];i=l[i];if(r==i){return 0}return r<i?1:-1});s=Ext.Array.slice(s,0,5);e=s.length;g.addColumn("date","Date");for(n=0;n<e;n++){g.addColumn("number",h.getByKey(s[n]).Title)}for(j in q){f=[new Date(j*1000)];v=q[j];for(n=0;n<e;n++){f.push(v[s[n]]||0)}g.addRow(f)}a.draw(g,{displayZoomButtons:false,numberFormats:"#,##0",scaleFormat:"#,##0",zoomStartTime:new Date(Date.now()-(1000*60*60*24*7))});Ext.callback(c,b)}})},initTopBytesEndpoints:function(c){var b=this,a=new google.visualization.AnnotationChart(Ext.fly("top-endpoints-bytes").appendChild({cls:"chart-timeline",style:{height:"400px"},html:"Loading chart&hellip;"},true));Ext.Ajax.request({method:"GET",url:"http://developer.phila.gov/metrics/endpoints-historic",withCredentials:true,params:{metrics:"bytesExecuted","time-min":"1 month ago"},headers:{Accept:"application/json"},success:function(m){var h=b.endpoints,d=Ext.decode(m.responseText),g=new google.visualization.DataTable(),k=d.data,u=k.length,n=0,q={},l={},s=[],o,j,p,t,v,f,e;for(;n<u;n++){o=k[n];j=o.Timestamp;p=o.EndpointID;t=o.Value;if(!(j in q)){q[j]={}}q[j][p]=t;if(!(p in l)){l[p]=0}l[p]+=t}s=Ext.Object.getKeys(l);s=Ext.Array.sort(s,function(r,i){r=l[r];i=l[i];if(r==i){return 0}return r<i?1:-1});s=Ext.Array.slice(s,0,5);e=s.length;g.addColumn("date","Date");for(n=0;n<e;n++){g.addColumn("number",h.getByKey(s[n]).Title)}for(j in q){f=[new Date(j*1000)];v=q[j];for(n=0;n<e;n++){f.push(v[s[n]]||0)}g.addRow(f)}a.draw(g,{displayZoomButtons:false,numberFormats:"#,##0",scaleFormat:"#,##0",zoomStartTime:new Date(Date.now()-(1000*60*60*24*7))});Ext.callback(c,b)}})},initTopTimeEndpoints:function(c){var b=this,a=new google.visualization.AnnotationChart(Ext.fly("top-endpoints-time").appendChild({cls:"chart-timeline",style:{height:"400px"},html:"Loading chart&hellip;"},true));Ext.Ajax.request({method:"GET",url:"http://developer.phila.gov/metrics/endpoints-historic",withCredentials:true,params:{metrics:"responseTime","time-min":"1 month ago"},headers:{Accept:"application/json"},success:function(m){var h=b.endpoints,d=Ext.decode(m.responseText),g=new google.visualization.DataTable(),k=d.data,u=k.length,n=0,q={},l={},s=[],o,j,p,t,v,f,e;for(;n<u;n++){o=k[n];j=o.Timestamp;p=o.EndpointID;t=o.Value;if(!(j in q)){q[j]={}}q[j][p]=t;if(!(p in l)){l[p]=0}l[p]+=t}s=Ext.Object.getKeys(l);s=Ext.Array.sort(s,function(r,i){r=l[r];i=l[i];if(r==i){return 0}return r<i?1:-1});s=Ext.Array.slice(s,0,5);e=s.length;g.addColumn("date","Date");for(n=0;n<e;n++){g.addColumn("number",h.getByKey(s[n]).Title)}for(j in q){f=[new Date(j*1000)];v=q[j];for(n=0;n<e;n++){f.push(v[s[n]]||0)}g.addRow(f)}a.draw(g,{displayZoomButtons:false,numberFormats:"#,##0",scaleFormat:"#,##0",zoomStartTime:new Date(Date.now()-(1000*60*60*24*7))});Ext.callback(c,b)}})}});